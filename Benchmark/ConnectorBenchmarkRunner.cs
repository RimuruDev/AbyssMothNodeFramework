// Dump:

// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
//
// Baseline double-loop: 59.666 ms | calls: 10000000 | ~5.97 ns/call | extra: 163732.3
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:203)
// AbyssMoth.ConnectorBenchmarkRunner:RunBaselineLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:139)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:84)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
//
// Interface list Step: 30.292 ms | calls: 10000000 | ~3.03 ns/call
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:205)
// AbyssMoth.ConnectorBenchmarkRunner:RunInterfaceLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:165)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:85)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
//
// LocalConnector Tick (cached): 182.26 ms | calls: 10000000 | ~18.23 ns/call
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:205)
// AbyssMoth.ConnectorBenchmarkRunner:RunLocalConnectorLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:188)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:86)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
//
// Baseline double-loop: 54.414 ms | calls: 10000000 | ~5.44 ns/call | extra: 163732.3
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:203)
// AbyssMoth.ConnectorBenchmarkRunner:RunBaselineLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:139)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:84)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
// Interface list Step: 29.201 ms | calls: 10000000 | ~2.92 ns/call
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:205)
// AbyssMoth.ConnectorBenchmarkRunner:RunInterfaceLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:165)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:85)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
// LocalConnector Tick (cached): 177.095 ms | calls: 10000000 | ~17.71 ns/call
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner:PrintResult (string,double,int,int,object) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:205)
// AbyssMoth.ConnectorBenchmarkRunner:RunLocalConnectorLoop (single) (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:188)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:86)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
// Unity Update probe started. Keep scene quiet for better signal.
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner/<UnityUpdateProbeCoroutine>d__19:MoveNext () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:210)
// UnityEngine.MonoBehaviour:StartCoroutine (System.Collections.IEnumerator)
// AbyssMoth.ConnectorBenchmarkRunner:RunBenchmark () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:89)
// System.Reflection.MethodBase:Invoke (object,object[])
// NaughtyAttributes.Editor.NaughtyEditorGUI:Button (UnityEngine.Object,System.Reflection.MethodInfo) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/Utility/NaughtyEditorGUI.cs:167)
// NaughtyAttributes.Editor.NaughtyInspector:DrawButtons (bool) (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:188)
// NaughtyAttributes.Editor.NaughtyInspector:OnInspectorGUI () (at Assets/AbyssMothFramework/Plugins/NAP/NaughtyAttributes/Scripts/Editor/NaughtyInspector.cs:52)
// UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&) (at /Users/bokken/build/output/unity/unity/Modules/IMGUI/GUIUtility.cs:224)
//
// Unity BehaviourUpdate avg: 0.179 ms/frame (frames: 300)
// UnityEngine.Debug:Log (object)
// AbyssMoth.ConnectorBenchmarkRunner/<UnityUpdateProbeCoroutine>d__19:MoveNext () (at Assets/AbyssMothNodeFramework/Benchmark/ConnectorBenchmarkRunner.cs:249)
// UnityEngine.SetupCoroutine:InvokeMoveNext (System.Collections.IEnumerator,intptr) (at /Users/bokken/build/output/unity/unity/Runtime/Export/Scripting/Coroutines.cs:17)
//
// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
// ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== 
//

// Brain activation :D
//
// Разбор чисел:
//  Сделал nodesCount=1000, tickLoops=10000 → 10 000 000 вызовов.
//  Interface list Step: ~29–30 ms на 10 млн → ~3 ns/call
//  LocalConnector cached: ~177–182 ms на 10 млн → ~18 ns/call
//
// Разница ~ 15 ns на вызов (18-3).
//
// Теперь переведём в реальность игры:
//  Если у нас 1000 тикающих нод в кадр
//  15 ns * 1000 = 15000 ns = 0.015 ms разницы на кадр.
//  Это вообще ни о чём. Особенно учитывая размер моих игр:3
//
// Даже если 5000 нод:
//  15 ns * 5000 = 0.075 ms на кадр.
//  То есть по CPU-оверходу диспатча моя система выглядит нормально.


using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using NaughtyAttributes;
using Unity.Profiling;
using UnityEngine;
using UnityEngine.Scripting;
using Debug = UnityEngine.Debug;

// ReSharper disable NotAccessedField.Local

namespace AbyssMoth
{
    public interface IBenchmarkStep
    {
        public void Step(float deltaTime);
    }

    [Preserve]
    public sealed class BenchmarkInterfaceAgent : IBenchmarkStep
    {
        private float value;

        public void Step(float deltaTime)
        {
            value += deltaTime;
        }
    }

    [Preserve]
    [DisallowMultipleComponent]
    public sealed class BenchmarkTickNode : ConnectorNode
    {
        private float value;

        public override void Tick(float deltaTime)
        {
            value += deltaTime;
        }
    }

    [Preserve]
    [DefaultExecutionOrder(-32000)]
    [DisallowMultipleComponent]
    public sealed class ConnectorBenchmarkRunner : MonoBehaviour
    {
        [BoxGroup("Config")]
        [SerializeField, Min(1)] private int nodesCount = 1000;

        [BoxGroup("Config")]
        [SerializeField, Min(1)] private int tickLoops = 10000;

        [BoxGroup("Config")]
        [SerializeField, Min(0)] private int warmupLoops = 300;

        [BoxGroup("Config")]
        [SerializeField] private bool runUnityUpdateProbe;

        [BoxGroup("Config")]
        [SerializeField, Min(1)] private int unityProbeFrames = 300;

        private readonly List<IBenchmarkStep> interfaceAgents = new();
        private LocalConnector connector;
        private ServiceRegistry registry;
        private GameObject root;

        [Button("Run Benchmark")]
        public void RunBenchmark()
        {
            if (!Application.isPlaying)
            {
                Debug.LogWarning("Run in Play Mode.");
                return;
            }

            Cleanup();

            SetupInterfaceAgents();
            SetupLocalConnector();

            var deltaTime = 0.016666668f;

            RunBaselineLoop(deltaTime);
            RunInterfaceLoop(deltaTime);
            RunLocalConnectorLoop(deltaTime);

            if (runUnityUpdateProbe)
                StartCoroutine(UnityUpdateProbeCoroutine());
        }

        private void SetupInterfaceAgents()
        {
            interfaceAgents.Clear();

            for (var i = 0; i < nodesCount; i++)
                interfaceAgents.Add(new BenchmarkInterfaceAgent());
        }

        private void SetupLocalConnector()
        {
            registry = new ServiceRegistry();

            root = new GameObject($"BenchmarkRoot {nodesCount}");
            root.transform.SetParent(transform, worldPositionStays: false);

            var connectorGo = new GameObject("BenchmarkLocalConnector");
            connectorGo.transform.SetParent(root.transform, worldPositionStays: false);

            connector = connectorGo.AddComponent<LocalConnector>();

            for (var i = 0; i < nodesCount; i++)
            {
                var nodeGo = new GameObject($"Node {i}");
                nodeGo.transform.SetParent(connectorGo.transform, worldPositionStays: false);
                nodeGo.AddComponent<BenchmarkTickNode>();
            }

            connector.CollectNodes();
            connector.Execute(registry, sender: this);
        }

        private void RunBaselineLoop(float deltaTime)
        {
            var sink = 0f;

            WarmupBaseline(deltaTime, ref sink);

            var sw = Stopwatch.StartNew();

            for (var i = 0; i < tickLoops; i++)
            {
                for (var j = 0; j < nodesCount; j++)
                    sink += deltaTime;
            }

            sw.Stop();

            PrintResult("Baseline double-loop", sw.Elapsed.TotalMilliseconds, nodesCount, tickLoops, sink);
        }

        private void WarmupBaseline(float deltaTime, ref float sink)
        {
            for (var i = 0; i < warmupLoops; i++)
            {
                for (var j = 0; j < nodesCount; j++)
                    sink += deltaTime;
            }
        }

        private void RunInterfaceLoop(float deltaTime)
        {
            WarmupInterface(deltaTime);

            var sw = Stopwatch.StartNew();

            for (var i = 0; i < tickLoops; i++)
            {
                for (var j = 0; j < interfaceAgents.Count; j++)
                    interfaceAgents[j].Step(deltaTime);
            }

            sw.Stop();

            PrintResult("Interface list Step", sw.Elapsed.TotalMilliseconds, nodesCount, tickLoops, extra: null);
        }

        private void WarmupInterface(float deltaTime)
        {
            for (var i = 0; i < warmupLoops; i++)
            {
                for (var j = 0; j < interfaceAgents.Count; j++)
                    interfaceAgents[j].Step(deltaTime);
            }
        }

        private void RunLocalConnectorLoop(float deltaTime)
        {
            WarmupLocalConnector(deltaTime);

            var sw = Stopwatch.StartNew();

            for (var i = 0; i < tickLoops; i++)
                connector.Tick(deltaTime);

            sw.Stop();

            PrintResult("LocalConnector Tick (cached)", sw.Elapsed.TotalMilliseconds, nodesCount, tickLoops, extra: null);
        }

        private void WarmupLocalConnector(float deltaTime)
        {
            for (var i = 0; i < warmupLoops; i++)
                connector.Tick(deltaTime);
        }

        private void PrintResult(string label, double ms, int count, int loops, object extra)
        {
            var totalCalls = (long)count * loops;
            var nsPerCall = (ms * 1_000_000.0) / totalCalls;

            if (extra != null)
                Debug.Log($"{label}: {ms:0.###} ms | calls: {totalCalls} | ~{nsPerCall:0.##} ns/call | extra: {extra}");
            else
                Debug.Log($"{label}: {ms:0.###} ms | calls: {totalCalls} | ~{nsPerCall:0.##} ns/call");
        }

        private IEnumerator UnityUpdateProbeCoroutine()
        {
            Debug.Log("Unity Update probe started. Keep scene quiet for better signal.");

            var agentsRoot = new GameObject($"UnityUpdateAgents {nodesCount}");
            agentsRoot.transform.SetParent(transform, worldPositionStays: false);

            for (var i = 0; i < nodesCount; i++)
            {
                var go = new GameObject($"UpdateAgent {i}");
                go.transform.SetParent(agentsRoot.transform, worldPositionStays: false);
                go.AddComponent<UnityUpdateAgent>();
            }

            var recorder = default(ProfilerRecorder);

            try
            {
                recorder = ProfilerRecorder.StartNew(ProfilerCategory.Scripts, "BehaviourUpdate");
            }
            catch (Exception e)
            {
                Debug.LogWarning($"ProfilerRecorder marker not available: {e.Message}");
            }

            for (var i = 0; i < 10; i++)
                yield return null;

            if (recorder.Valid)
            {
                var sum = 0d;

                for (var i = 0; i < unityProbeFrames; i++)
                {
                    yield return null;

                    if (recorder.LastValue > 0)
                        sum += recorder.LastValue / 1_000_000.0;
                }

                var avg = sum / Mathf.Max(1, unityProbeFrames);
                Debug.Log($"Unity BehaviourUpdate avg: {avg:0.###} ms/frame (frames: {unityProbeFrames})");
            }
            else
            {
                Debug.Log("Unity probe skipped (no recorder). Use Profiler window if needed.");
            }

            if (recorder.Valid)
                recorder.Dispose();

            Destroy(agentsRoot);
        }

        private void Cleanup()
        {
            interfaceAgents.Clear();

            if (root != null)
                Destroy(root);

            root = null;
            connector = null;
            registry = null;
        }

        [Preserve]
        [DisallowMultipleComponent]
        private sealed class UnityUpdateAgent : MonoBehaviour
        {
            private float value;

            public void Update() => 
                value += 1f;
        }
    }
}